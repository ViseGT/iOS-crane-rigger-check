<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>èµ·é‡æ©Ÿä½œæ¥­å‰è‡ªæª¢è¡¨</title>
    
    <link rel="manifest" href="manifest.json">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="èµ·é‡æ©Ÿæª¢æŸ¥">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <meta name="theme-color" content="#2c3e50">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        /* === å…¨å±€æ¨£å¼ === */
        body { 
            padding: 15px; 
            padding-bottom: 120px; 
            background-color: #e9ecef; 
            font-family: -apple-system, "Microsoft JhengHei", "Heiti TC", sans-serif; 
            color: #333; 
            /* é˜²æ­¢ iOS æ©¡çš®ç­‹è¿´å½ˆæ•ˆæœ */
            overscroll-behavior-y: none;
        }
        
        #app-container { max-width: 800px; margin: 0 auto; }
        
        .card-box { 
            background: white; padding: 20px; border-radius: 12px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; position: relative;
        }
        .app-header { text-align: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #f0f0f0; }
        .app-title { font-size: 1.5rem; font-weight: 900; color: #2c3e50; }
        .section-title { font-size: 1.1rem; font-weight: bold; color: #0d6efd; margin-bottom: 15px; border-left: 4px solid #0d6efd; padding-left: 10px;}
        label { font-weight: bold; color: #555; margin-bottom: 5px; display: block; font-size: 0.95rem; }
        input[type="text"], input[type="date"], select { 
            width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 8px; 
            font-size: 16px; margin-bottom: 15px; background: #fff; 
        }
        .panel-row { 
            background: white; margin-bottom: 15px; padding: 15px; border-radius: 12px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 6px solid #ccc; 
        }
        .panel-row.completed { border-left-color: #198754; } 
        .panel-row.error { border-left-color: #dc3545; background-color: #fff8f8; }
        .item-title { font-weight: bold; font-size: 1.1rem; color: #222; margin-bottom: 10px; line-height: 1.4; }

        .illustration-container {
            text-align: center; margin-bottom: 15px; padding: 10px;
            background-color: #f8f9fa; border-radius: 8px; border: 2px dashed #dee2e6;
        }
        .illustration-img {
            max-width: 100%; max-height: 200px; object-fit: contain; border-radius: 4px; border: 1px solid #eee;
        }

        .btn-check-group { display: flex; gap: 5px; width: 100%; }
        .btn-check-group input { display: none; }
        .btn-check-label { 
            flex: 1; text-align: center; padding: 12px; border: 1px solid #ced4da; 
            border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: bold; 
            background: #fff; color: #666; transition: 0.2s;
        }
        .btn-check-pass:checked + label { background: #198754; color: white; border-color: #198754; }
        .btn-check-fail:checked + label { background: #dc3545; color: white; border-color: #dc3545; }
        .preview-container { text-align: center; margin-top: 10px; }
        .preview-img { max-width: 100%; height: 200px; object-fit: contain; border-radius: 8px; border: 1px solid #ddd; display: none; margin-top: 5px; }
        
        .sig-wrapper { 
            width: 100%; height: 180px; border: 2px dashed #bbb; border-radius: 8px; 
            background: #fff; touch-action: none; position: relative;
        }
        canvas { width: 100%; height: 100%; display: block; cursor: crosshair; }
        .sig-error { border-color: #dc3545; background: #fff5f5; }
        .fab-container { position: fixed; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 1000; align-items: flex-end; }
        .btn-float { 
            padding: 12px 20px; border-radius: 50px; color: white; font-weight: bold; border: none; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; min-width: 120px; font-size: 1rem;
        }
        .btn-main { background: linear-gradient(135deg, #0d6efd, #0b5ed7); }
        .btn-warn { background: linear-gradient(135deg, #dc3545, #b02a37); font-size: 0.9rem; min-width: 100px; }
        
        /* å®‰è£æç¤º (iOSç”¨) */
        #ios-install-prompt {
            display: none;
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: white; padding: 20px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 2000; text-align: center;
        }
        #ios-install-prompt p { margin-bottom: 10px; font-size: 0.9rem; }
    </style>
</head>
<body>

<div class="fab-container" id="fab-menu">
    <button type="button" class="btn-float btn-main" onclick="downloadReport()">ğŸ“¥ ä¸‹è¼‰å ±å‘Š</button>
    <button type="button" class="btn-float btn-warn" onclick="clearDraft()">ğŸ—‘ï¸ æ¸…é™¤é‡å¡«</button>
</div>

<div class="container" id="app-container">
    <form id="checkForm">
        <div class="card-box">
            <div class="app-header">
                <div class="app-title">ğŸ—ï¸ èµ·é‡æ©Ÿä½œæ¥­å‰è‡ªæª¢è¡¨</div>
                <small id="autoSaveStatus" style="color:#198754; display:none; font-weight:bold;">âœ… å·²è‡ªå‹•å„²å­˜</small>
            </div>
            <div class="section-title">1. ä½œæ¥­åŸºæœ¬è³‡æ–™ (å¿…å¡«)</div>
            <div class="row">
                <div class="col-12"><label>æª¢æŸ¥æ—¥æœŸ Date</label><input type="date" id="checkDate"></div>
            </div>
            <div class="row">
                <div class="col-6"><label>1. ä¸»æ‰¿å•† Main Contractor</label><input type="text" id="mainContractor" placeholder="è¼¸å…¥ä¸»æ‰¿å•†..." oninput="autoSave()"></div>
                <div class="col-6"><label>2. æ¬¡æ‰¿å•† Sub Contractor</label><input type="text" id="subContractor" placeholder="è¼¸å…¥æ¬¡æ‰¿å•†..." oninput="autoSave()"></div>
            </div>
            <div class="row">
                <div class="col-6"><label>3. æª¢æŸ¥äººå“¡ Inspector</label><input type="text" id="inspectorName" placeholder="è¼¸å…¥å§“å..." oninput="autoSave()"></div>
                <div class="col-6"><label>4. åŠæ›é»ä½ Lifting Point</label><input type="text" id="liftingPoint" placeholder="è¼¸å…¥é»ä½..." oninput="autoSave()"></div>
            </div>
        </div>

        <div id="panelList"></div>

        <div class="card-box" id="sig-section">
            <div class="section-title">3. ç°½åç¢ºèª Signature (å¿…å¡«)</div>
            <div class="sig-wrapper" id="sig-container">
                <canvas id="sig-canvas"></canvas>
            </div>
            <div style="margin-top:10px; text-align:right;">
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearSignature()">â†º æ¸…é™¤é‡ç°½</button>
            </div>
        </div>
    </form>
</div>

<div id="ios-install-prompt">
    <p>ğŸ“² <strong>å®‰è£åˆ°æ‰‹æ©Ÿï¼š</strong><br>é»æ“Šä¸‹æ–¹åˆ†äº«æŒ‰éˆ• <img src="https://img.icons8.com/ios-glyphs/30/000000/share-rounded.png" style="width:20px; vertical-align:middle;">ï¼Œç„¶å¾Œé¸æ“‡ã€ŒåŠ å…¥ä¸»ç•«é¢ã€</p>
    <button class="btn btn-sm btn-outline-dark" onclick="document.getElementById('ios-install-prompt').style.display='none'">é—œé–‰</button>
</div>

<script>
    // è¨»å†Š Service Worker (PWA æ ¸å¿ƒ)
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => console.log('SW registered!', reg))
                .catch(err => console.log('SW failed', err));
        });
    }

    // æª¢æ¸¬æ˜¯å¦ç‚º iOS ä¸”æœªå®‰è£ï¼Œé¡¯ç¤ºæç¤º
    const isIos = () => {
        const userAgent = window.navigator.userAgent.toLowerCase();
        return /iphone|ipad|ipod/.test(userAgent);
    }
    const isInStandaloneMode = () => ('standalone' in window.navigator) && (window.navigator.standalone);

    if (isIos() && !isInStandaloneMode()) {
        // ç¨å¾®å»¶é²é¡¯ç¤ºæç¤ºï¼Œé¿å…å¹²æ“¾
        setTimeout(() => {
            document.getElementById('ios-install-prompt').style.display = 'block';
        }, 2000);
    }

    // 1. è³‡æ–™è¨­å®š
    const QUESTIONS = [
        { title: "1. åŠæ›é‰¤é ­æ’éŠ·æ˜¯å¦å®Œå…¨æ’å…¥ï¼Ÿ", image: "demo1.jpg" },
        { title: "2. åŠé‰¤é˜²æ»‘èˆŒç‰‡æ˜¯å¦ç„¡è®Šå½¢ï¼Ÿ", image: "demo2.jpg" },
        { title: "3. éæ²é é˜²è£ç½®æ˜¯å¦åŠŸèƒ½æ­£å¸¸ï¼Ÿ", image: "" },
        { title: "4. åŠæ›ç´¢å…·æ˜¯å¦ç„¡æ–·çµ²ã€æ–·è‚¡ï¼Ÿ", image: "" },
        { title: "5. ä½œæ¥­ç¯„åœå…§æ˜¯å¦å·²å®Œæˆäººå“¡æ·¨ç©ºï¼Ÿ", image: "" },
        { title: "6. åŠæ›ä½œæ¥­æ˜¯å¦ç”±åˆæ ¼åŠæ›æ‰‹æŒ‡æ®ï¼Ÿ", image: "" }
    ];

    const DB_NAME = "CraneCheckDB_V3"; 
    const DB_VERSION = 1; 
    let db;
    const request = indexedDB.open(DB_NAME, DB_VERSION);
    request.onupgradeneeded = (e) => { db = e.target.result; if(!db.objectStoreNames.contains("drafts")) db.createObjectStore("drafts", { keyPath: "id" }); };
    request.onsuccess = (e) => { db = e.target.result; initPage(); };

    // 2. ç°½åæ¿
    const canvas = document.getElementById('sig-canvas');
    const ctx = canvas.getContext('2d');
    let isDrawing = false;

    function resizeCanvas() {
        const wrapper = canvas.parentElement;
        const rect = wrapper.getBoundingClientRect();
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = rect.width * ratio;
        canvas.height = rect.height * ratio;
        ctx.scale(ratio, ratio);
        ctx.lineWidth = 3; ctx.lineCap = 'round'; ctx.lineJoin = 'round'; ctx.strokeStyle = '#000';
    }
    window.addEventListener('resize', resizeCanvas);

    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: clientX - rect.left, y: clientY - rect.top };
    }
    function startDraw(e) { if(e.target === canvas) e.preventDefault(); isDrawing = true; const pos = getPos(e); ctx.beginPath(); ctx.moveTo(pos.x, pos.y); }
    function draw(e) { if (!isDrawing) return; if(e.target === canvas) e.preventDefault(); const pos = getPos(e); ctx.lineTo(pos.x, pos.y); ctx.stroke(); }
    function stopDraw() { if(isDrawing) { isDrawing = false; autoSave(); } }
    canvas.addEventListener('mousedown', startDraw); canvas.addEventListener('mousemove', draw); 
    canvas.addEventListener('mouseup', stopDraw); canvas.addEventListener('mouseout', stopDraw);
    canvas.addEventListener('touchstart', startDraw, {passive:false}); canvas.addEventListener('touchmove', draw, {passive:false}); canvas.addEventListener('touchend', stopDraw);
    function clearSignature() { ctx.clearRect(0, 0, canvas.width, canvas.height); autoSave(); }
    function isCanvasBlank() { const blank = document.createElement('canvas'); blank.width = canvas.width; blank.height = canvas.height; return canvas.toDataURL() === blank.toDataURL(); }

    // 3. é é¢åˆå§‹åŒ–
    function initPage() {
        const now = new Date();
        document.getElementById('checkDate').value = now.toISOString().split('T')[0];
        renderPanels();
        loadDraftFromDB();
        setTimeout(resizeCanvas, 100);
    }
     // â˜…â˜…â˜… æ¸²æŸ“å¡ç‰‡é‚è¼¯ â˜…â˜…â˜…
    function renderPanels() {
        const container = document.getElementById('panelList'); 
        container.innerHTML = `<div class="section-title">2. æª¢æŸ¥é …ç›® Checklist</div>`;
       
        QUESTIONS.forEach((qData, idx) => {
            let illustrationHtml = "";
            // æ™®é€šé¡Œç›®è‹¥æœ‰åœ–å‰‡é¡¯ç¤º
            if(qData.image && qData.specialType !== "rigging") {
                illustrationHtml = `
                <div class="illustration-container">
                    <span class="badge bg-secondary mb-2">åƒè€ƒç¤ºæ„åœ–</span><br>
                    <img src="${qData.image}" class="illustration-img" onerror="this.src='https://placehold.co/600x400?text=ç„¡ç¤ºæ„åœ–';this.alt='ç„¡åœ–ç‰‡';" alt="${qData.title} ç¤ºæ„åœ–">
                </div>`;
            }

            let specialMenuHtml = "";
            if (qData.specialType === "rigging") {
                specialMenuHtml = `
                <div class="rigging-select-container">
                    <label style="color:#0d6efd;">â¤ 1. è«‹é¸æ“‡åŠæ›å·¥å…·ç¨®é¡ï¼š</label>
                    <select id="rigging_type_select" onchange="updateRiggingCriteria(this.value); autoSave();">
                        <option value="" disabled selected>-- è«‹é¸æ“‡ --</option>
                        <option value="wire_rope">é‹¼ç´¢ (Wire Rope)</option>
                        <option value="chain">åŠéˆ (Chain)</option>
                        <option value="sling">çº–ç¶­åŠå¸¶ (Synthetic Sling)</option>
                    </select>
                    <div id="rigging_sub_questions_container" style="margin-top:10px;"></div>
                </div>`;
            }

            const html = `
            <div class="panel-row" id="row_${idx}">
                <div class="item-title">${qData.title}</div>
                ${specialMenuHtml}
                ${illustrationHtml}
                
                <div class="btn-check-group">
                    <input type="radio" class="btn-check-pass" name="q${idx}" id="q${idx}_pass" value="Pass" onchange="checkStatus(${idx}); autoSave()">
                     <label class="btn-check-label" for="q${idx}_pass">ç¸½çµï¼šåˆæ ¼</label>
                    <input type="radio" class="btn-check-fail" name="q${idx}" id="q${idx}_fail" value="Fail" onchange="checkStatus(${idx}); autoSave()">
                    <label class="btn-check-label" for="q${idx}_fail">ç¸½çµï¼šä¸åˆæ ¼</label>
                </div>
                
                <div style="margin-top:15px;">
                    <input type="text" id="note_${idx}" placeholder="å‚™è¨»èªªæ˜ (é¸å¡«)..." oninput="autoSave()">
                    <label class="btn btn-outline-secondary w-100" style="margin-top:5px;">
                        ğŸ“· æ‹æ”ç…§ç‰‡ / ä¸Šå‚³ç¾å ´åœ–
                        <input type="file" id="file_${idx}" accept="image/*" capture="environment" style="display:none" onchange="handleImage(this, ${idx})">
                    </label>
                    <div class="preview-container"><img id="preview_${idx}" class="preview-img"></div>
                </div>
            </div>`;
            container.innerHTML += html;
        });
    }
    // â˜…â˜…â˜… æ ¸å¿ƒï¼šæ›´æ–°å­é¡Œç›®èˆ‡åœ–ç‰‡ â˜…â˜…â˜…
    window.updateRiggingCriteria = function(typeKey) {
        const container = document.getElementById('rigging_sub_questions_container');
        container.innerHTML = ""; 

        if (RIGGING_TYPES[typeKey]) {
            const subQuestions = RIGGING_TYPES[typeKey].subQuestions;
            subQuestions.forEach((subQ, subIdx) => {
                // è™•ç†åœ–ç‰‡ (å¦‚æœæ²’æœ‰å°±ç”¨é è¨­)
                const imgSrc = subQ.image || "";
                let imgHtml = "";
                 if (imgSrc) {
                    imgHtml = `
                    <div class="sub-q-img-box">
                        <img src="${imgSrc}" class="sub-q-img" onerror="this.src='https://placehold.co/400x200?text=æ¨™æº–åœ–';this.alt='ç¤ºæ„åœ–'">
                    </div>`;
                }

                const subHtml = `
                <div class="sub-question-row">
                    <div class="sub-q-title">${subQ.text}</div>
                    ${imgHtml}
                    <div class="sub-btn-group">
                        <input type="radio" class="sub-btn-pass" name="q0_sub${subIdx}" id="q0_sub${subIdx}_pass" value="Pass" onchange="autoSave()">
                        <label class="sub-btn-label" for="q0_sub${subIdx}_pass">æ˜¯</label>
                        <input type="radio" class="sub-btn-fail" name="q0_sub${subIdx}" id="q0_sub${subIdx}_fail" value="Fail" onchange="autoSave()">
                        <label class="sub-btn-label" for="q0_sub${subIdx}_fail">å¦</label>
                    </div>
                </div>`;
                container.insertAdjacentHTML('beforeend', subHtml);
            });
        }
    }
window.checkStatus = function(idx) {
        const row = document.getElementById(`row_${idx}`);
        const pass = document.getElementById(`q${idx}_pass`).checked;
        const fail = document.getElementById(`q${idx}_fail`).checked;
        row.classList.remove('completed', 'error');
        if(pass) row.classList.add('completed');
        if(fail) row.classList.add('error');
    }

    window.handleImage = function(input, idx) {
        if(input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = document.getElementById(`preview_${idx}`);
                img.src = e.target.result; img.style.display = 'inline-block';
                autoSave();
            };
            reader.readAsDataURL(input.files[0]);
        }
    }
     
    // 4. è‡ªå‹•å„²å­˜
    const STORAGE_KEY = "CRANE_DRAFT_V3";
    let saveTimer; 
    window.autoSave = function() { clearTimeout(saveTimer); saveTimer = setTimeout(saveToDB, 500); }
    
    function saveToDB() {
        if(!db) return;
        const basicInfo = {
            date: document.getElementById('checkDate').value,
            main: document.getElementById('mainContractor').value,
            sub: document.getElementById('subContractor').value,
            insp: document.getElementById('inspectorName').value,
            point: document.getElementById('liftingPoint').value
        };
        const radios = Array.from(document.querySelectorAll('input[type="radio"]:checked')).map(r => r.id);
        const notes = Array.from(document.querySelectorAll('input[type="text"][id^="note_"]')).reduce((acc, el) => ({...acc, [el.id]: el.value}), {});
        const images = Array.from(document.querySelectorAll('.preview-img')).reduce((acc, img) => (img.src && img.src.startsWith('data:') ? {...acc, [img.id]: img.src} : acc), {});
        const data = { id: STORAGE_KEY, basicInfo: basicInfo, radios: radios, notes: notes, images: images, signature: isCanvasBlank() ? null : canvas.toDataURL() };
        const tx = db.transaction(["drafts"], "readwrite"); tx.objectStore("drafts").put(data);
        tx.oncomplete = () => { const status = document.getElementById('autoSaveStatus'); status.style.display='inline'; setTimeout(()=> status.style.display='none', 2000); };
    }

    function loadDraftFromDB() {
        if(!db) return;
        db.transaction(["drafts"]).objectStore("drafts").get(STORAGE_KEY).onsuccess = (e) => {
            const data = e.target.result; if(!data) return;
            if(data.basicInfo) {
                document.getElementById('checkDate').value = data.basicInfo.date || "";
                document.getElementById('mainContractor').value = data.basicInfo.main || "";
                document.getElementById('subContractor').value = data.basicInfo.sub || "";
                document.getElementById('inspectorName').value = data.basicInfo.insp || "";
                document.getElementById('liftingPoint').value = data.basicInfo.point || "";
            }
            if(data.radios) { data.radios.forEach(id => { const el = document.getElementById(id); if(el) { el.checked = true; } const idx = id.match(/\d+/)[0]; checkStatus(idx); }); }
            if(data.notes) Object.keys(data.notes).forEach(k => { const el = document.getElementById(k); if(el) el.value = data.notes[k]; });
            if(data.images) Object.keys(data.images).forEach(k => { const img = document.getElementById(k); if(img) { img.src = data.images[k]; img.style.display = 'inline-block'; } });
            if(data.signature) { const i = new Image(); i.src = data.signature; i.onload = () => ctx.drawImage(i,0,0, canvas.width, canvas.height); }
        };
    }

    window.clearDraft = function() { if(confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™é‡å¡«å—ï¼Ÿ")) { db.transaction(["drafts"], "readwrite").objectStore("drafts").delete(STORAGE_KEY); location.reload(); } }

    // 5. ä¸‹è¼‰ HTML å ±å‘Š (å–®ä¸€æª”æ¡ˆ)
    window.downloadReport = function() {
        const main = document.getElementById('mainContractor').value;
        const sub = document.getElementById('subContractor').value;
        const insp = document.getElementById('inspectorName').value;
        const point = document.getElementById('liftingPoint').value;
        const checkDate = document.getElementById('checkDate').value;
        
        if(!main || !sub || !insp || !point) { alert("âš ï¸ è«‹å¡«å¯«å®Œæ•´çš„ã€Œä½œæ¥­åŸºæœ¬è³‡æ–™ã€ï¼"); window.scrollTo(0,0); return; }
        if(isCanvasBlank()) { alert("âš ï¸ è«‹ç°½åï¼"); document.getElementById('sig-canvas').classList.add('sig-error'); document.getElementById('sig-section').scrollIntoView(); return; }
        
        let errorCount = 0; let firstErrorId = null;
        QUESTIONS.forEach((_, idx) => {
            const pass = document.getElementById(`q${idx}_pass`).checked;
            const fail = document.getElementById(`q${idx}_fail`).checked;
            if(!pass && !fail) { errorCount++; const row = document.getElementById(`row_${idx}`); row.classList.add('error'); if(!firstErrorId) firstErrorId = `row_${idx}`; }
        });
        if(errorCount > 0) { alert(`âŒ å°šæœ‰ ${errorCount} å€‹æª¢æŸ¥é …ç›®æœªå‹¾é¸ï¼`); document.getElementById(firstErrorId).scrollIntoView({behavior:'smooth', block:'center'}); return; }

        let reportItemsHtml = ""; 
        let failCount = 0;
        QUESTIONS.forEach((qData, idx) => {
            const isPass = document.getElementById(`q${idx}_pass`).checked;
            const noteVal = document.getElementById(`note_${idx}`).value;
            const imgEl = document.getElementById(`preview_${idx}`);
            if(!isPass) failCount++;
            
            const statusHtml = isPass ? '<span class="txt-pass">âœ” åˆæ ¼</span>' : '<span class="txt-fail">âœ˜ ç•°å¸¸</span>';
            const noteHtml = noteVal ? `<div style="margin-top:2px; font-size:14px; color:#555;">å‚™è¨»ï¼š${noteVal}</div>` : "";
            const imgHtml = (imgEl && imgEl.src && imgEl.style.display !== 'none') ? `<img src="${imgEl.src}" class="report-img-large">` : "";

            reportItemsHtml += `
            <div class="report-item" style="${!isPass ? 'background-color:#fff5f5;' : ''}">
                <div class="report-item-head"><span>${qData.title}</span> ${statusHtml}</div>
                ${noteHtml}
                ${imgHtml}
            </div>`;
        });

        const fullHtml = `
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>èµ·é‡æ©Ÿæª¢æŸ¥å ±å‘Š</title>
    <style>
        body { font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; padding: 40px; background: #fff; color: #000; margin: 0; }
        .container { max-width: 800px; margin: 0 auto; border: 1px solid #ddd; padding: 30px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .report-header { text-align: center; border-bottom: 2px solid #0d6efd; margin-bottom: 20px; padding-bottom: 10px; }
        .report-title { font-size: 28px; font-weight: 900; margin: 0; color: #000; }
        .report-info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; border: 1px solid #ddd; padding: 20px; border-radius: 5px; background: #f9f9f9; font-size: 16px; }
        .report-section-title { font-size: 18px; font-weight: bold; color: #0d6efd; border-left: 5px solid #0d6efd; padding-left: 10px; margin-bottom: 15px; margin-top: 25px; }
        .report-item { border-bottom: 1px solid #eee; padding: 12px 0; }
        .report-item-head { font-weight: bold; font-size: 16px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .report-img-large { max-height: 300px; max-width: 100%; border: 1px solid #ccc; display: block; margin: 8px 0; border-radius: 4px; }
        .report-footer { margin-top: 40px; display: flex; justify-content: space-between; }
        .report-sig-box { text-align: center; width: 45%; }
        .report-sig-line { border-top: 1px solid #000; padding-top: 8px; font-weight: bold; margin-top: 5px; font-size: 16px;}
        .report-sig-img { height: 70px; display: block; margin: 0 auto; }
        .txt-pass { color: #198754; } .txt-fail { color: #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <div class="report-header"><div class="report-title">ğŸ—ï¸ èµ·é‡æ©Ÿä½œæ¥­å‰è‡ªæª¢è¡¨</div></div>
        <div class="report-info-grid">
            <div><strong>æ—¥æœŸï¼š</strong> ${checkDate}</div>
            <div><strong>ä¸»æ‰¿å•†ï¼š</strong> ${main}</div>
            <div><strong>æ¬¡æ‰¿å•†ï¼š</strong> ${sub}</div>
            <div><strong>åŠæ›é»ä½ï¼š</strong> ${point}</div>
            <div><strong>æª¢æŸ¥äººå“¡ï¼š</strong> ${insp}</div>
        </div>
        <div class="report-section-title">æª¢æŸ¥çµæœç´°é …</div>
        <div>${reportItemsHtml}</div>
        <div style="margin-top:20px; font-size:18px; font-weight:bold; border-top:2px solid #ccc; padding-top:10px;">
            ç¸½çµï¼š${failCount > 0 ? '<span style="color:red">ç•°å¸¸ (' + failCount + ' é …) - è«‹ç«‹å³æ”¹å–„</span>' : '<span style="color:green">å…¨æ•¸åˆæ ¼ - å¯é–‹å§‹ä½œæ¥­</span>'}
        </div>
        <div class="report-footer">
            <div class="report-sig-box"><img src="${canvas.toDataURL()}" class="report-sig-img"><div class="report-sig-line">æª¢æŸ¥äººå“¡ç°½ç« </div></div>
            <div class="report-sig-box"><div style="height:70px;"></div><div class="report-sig-line">å·¥åœ°ä¸»ä»»/ç›£å·¥è¤‡æ ¸</div></div>
        </div>
    </div>
</body>
</html>`;

        const blob = new Blob([fullHtml], {type: "text/html;charset=utf-8"});
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `èµ·é‡æ©Ÿæª¢æŸ¥å ±å‘Š_${checkDate}_${point}.html`;
        link.click();
    }
</script>
</body>
</html>

